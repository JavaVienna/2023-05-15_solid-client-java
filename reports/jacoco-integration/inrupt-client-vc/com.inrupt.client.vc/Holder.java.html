<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>Holder.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Inrupt Client Libraries - Report</a> &gt; <a href="../index.html" class="el_bundle">inrupt-client-vc</a> &gt; <a href="index.source.html" class="el_package">com.inrupt.client.vc</a> &gt; <span class="el_source">Holder.java</span></div><h1>Holder.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2022 Inrupt Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal in
 * the Software without restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the
 * Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
 * INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
 * PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
package com.inrupt.client.vc;

import com.inrupt.client.Request;
import com.inrupt.client.Response;
import com.inrupt.client.VerifiableCredential;
import com.inrupt.client.VerifiablePresentation;
import com.inrupt.client.spi.HttpService;
import com.inrupt.client.spi.JsonService;
import com.inrupt.client.spi.ServiceProvider;
import com.inrupt.client.util.IOUtils;
import com.inrupt.client.util.URIBuilder;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.concurrent.CompletionStage;
import java.util.stream.Collectors;

/**
 * A class for interacting with a VC-API Holder endpoint.
 *
 * @see &lt;a href=&quot;https://w3c-ccg.github.io/vc-api/holder.html&quot;&gt;VC-API: Holder&lt;/a&gt;
 */
public class Holder {

    private static final String CONTENT_TYPE = &quot;Content-Type&quot;;
    private static final String APPLICATION_JSON = &quot;application/json&quot;;
    private static final String CREDENTIALS = &quot;credentials&quot;;
    private static final String PRESENTATIONS = &quot;presentations&quot;;
    private static final String EXCHANGES = &quot;exchanges&quot;;

    private final URI baseUri;
    private final HttpService httpClient;
    private final JsonService jsonService;

    /**
     * Create a new Holder object for interacting with a VC-API.
     *
     * @param baseUri the base URI for the VC-API
     */
    public Holder(final URI baseUri) {
<span class="nc" id="L68">        this(baseUri, ServiceProvider.getHttpService());</span>
<span class="nc" id="L69">    }</span>

    /**
     * Create a new Holder object for interacting with a VC-API.
     *
     * @param baseUri the base URI for the VC-API
     * @param httpClient an HTTP client
     */
<span class="nc" id="L77">    public Holder(final URI baseUri, final HttpService httpClient) {</span>
<span class="nc" id="L78">        this.baseUri = baseUri;</span>
<span class="nc" id="L79">        this.httpClient = httpClient;</span>
<span class="nc" id="L80">        this.jsonService = ServiceProvider.getJsonService();</span>
<span class="nc" id="L81">    }</span>

    /**
     * List all verifiable credentials.
     *
     * @return the next stage of completion, including the list of verifiable credentials
     */
    public CompletionStage&lt;List&lt;VerifiableCredential&gt;&gt; listCredentials() {
<span class="nc" id="L89">        return listCredentials(Collections.emptyList());</span>
    }

    /**
     * List all verifiable credentials, filtered by a list of types.
     *
     * @param types the VC types on which to filter
     * @return the next stage of completion, including the list of verifiable credentials
     */
    public CompletionStage&lt;List&lt;VerifiableCredential&gt;&gt; listCredentials(final List&lt;URI&gt; types) {
<span class="nc" id="L99">        final var req = Request.newBuilder(getCredentialListEndpoint(Objects.requireNonNull(types))).build();</span>
<span class="nc" id="L100">        return httpClient.send(req, Response.BodyHandlers.ofInputStream())</span>
<span class="nc" id="L101">            .thenApply(res -&gt; {</span>
                try {
<span class="nc" id="L103">                    final int httpStatus = res.statusCode();</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">                    if (httpStatus &gt;= 200 &amp;&amp; httpStatus &lt; 300) {</span>
<span class="nc" id="L105">                        return jsonService.fromJson(res.body(),</span>
<span class="nc" id="L106">                            new ArrayList&lt;VerifiableCredential&gt;(){}.getClass().getGenericSuperclass());</span>
                    }
<span class="nc" id="L108">                    throw new VerifiableCredentialException(</span>
                        &quot;Unexpected error response while listing credentials&quot;,
                        httpStatus);
<span class="nc" id="L111">                } catch (final IOException ex) {</span>
<span class="nc" id="L112">                    throw new VerifiableCredentialException(</span>
                        &quot;Unexpected I/O exception while listing credentials&quot;,
                        ex);
                }
            });
    }

    /**
     * Retrieve a verifiable credential.
     *
     * @param credentialId the credential identifier
     * @return the next stage of completion, including a verifiable credential
     */
    public CompletionStage&lt;VerifiableCredential&gt; getCredential(final String credentialId) {
<span class="nc" id="L126">        final var req = Request</span>
<span class="nc" id="L127">                .newBuilder(getCredentialEndpoint(Objects.requireNonNull(credentialId))).build();</span>
<span class="nc" id="L128">        return httpClient.send(req, VerifiableCredentialBodyHandlers.ofVerifiableCredential())</span>
<span class="nc" id="L129">                .thenApply(Response::body);</span>
    }

    /**
     * Delete a credential.
     *
     * @param credentialId the credential identifier
     * @return the next stage of compltion
     */
    public CompletionStage&lt;Void&gt; deleteCredential(final String credentialId) {
<span class="nc" id="L139">        final var req = Request.newBuilder(getCredentialEndpoint(Objects.requireNonNull(credentialId)))</span>
<span class="nc" id="L140">            .DELETE().build();</span>

<span class="nc" id="L142">        return httpClient.send(req, Response.BodyHandlers.discarding())</span>
<span class="nc" id="L143">            .thenApply(res -&gt; {</span>
<span class="nc" id="L144">                final int httpStatus = res.statusCode();</span>
<span class="nc bnc" id="L145" title="All 4 branches missed.">                if (httpStatus &gt;= 200 &amp;&amp; httpStatus &lt; 300) {</span>
<span class="nc" id="L146">                    return res.body();</span>
                }
<span class="nc" id="L148">                throw new VerifiableCredentialException(</span>
                    &quot;Unexpected error while deleting credential&quot;,
                    httpStatus);
            });
    }

    /**
     * Derive a credential.
     *
     * @param request the selective disclosure request
     * @return the next stage of completion, including the derived verifiable credential
     */
    public CompletionStage&lt;VerifiableCredential&gt; derive(final DerivationRequest request) {
<span class="nc" id="L161">        final var req = Request.newBuilder(getDeriveEndpoint())</span>
<span class="nc" id="L162">            .header(CONTENT_TYPE, APPLICATION_JSON)</span>
<span class="nc" id="L163">            .POST(serialize(request))</span>
<span class="nc" id="L164">            .build();</span>

<span class="nc" id="L166">        return httpClient.send(req, VerifiableCredentialBodyHandlers.ofVerifiableCredential())</span>
<span class="nc" id="L167">                .thenApply(Response::body);</span>
    }

    /**
     * Retrieve a list of presentations.
     *
     * @return the next stage of completion, including a list of presentations
     */
    public CompletionStage&lt;List&lt;VerifiablePresentation&gt;&gt; listPresentations() {
<span class="nc" id="L176">        return listPresentations(Collections.emptyList());</span>
    }

    /**
     * Retrieve a list of presentations.
     *
     * @param types presentation type filters
     * @return the next stage of completion, including a list of presentations
     */
    public CompletionStage&lt;List&lt;VerifiablePresentation&gt;&gt; listPresentations(final List&lt;URI&gt; types) {
<span class="nc" id="L186">        final var req = Request.newBuilder(getPresentationListEndpoint(Objects.requireNonNull(types))).build();</span>
<span class="nc" id="L187">        return httpClient.send(req, Response.BodyHandlers.ofInputStream())</span>
<span class="nc" id="L188">            .thenApply(res -&gt; {</span>
                try {
<span class="nc" id="L190">                    final int httpStatus = res.statusCode();</span>
<span class="nc bnc" id="L191" title="All 4 branches missed.">                    if (httpStatus &gt;= 200 &amp;&amp; httpStatus &lt; 300) {</span>
<span class="nc" id="L192">                        return jsonService.fromJson(res.body(),</span>
<span class="nc" id="L193">                            new ArrayList&lt;VerifiablePresentation&gt;(){}.getClass().getGenericSuperclass());</span>
                    }
<span class="nc" id="L195">                    throw new VerifiableCredentialException(</span>
                        &quot;Unexpected error response while listing presentations.&quot;,
                        httpStatus);
<span class="nc" id="L198">                } catch (final IOException ex) {</span>
<span class="nc" id="L199">                    throw new VerifiableCredentialException(</span>
                        &quot;Unexpected I/O exception while listing presentations&quot;,
                        ex);
                }
            });
    }

    /**
     * Retrieve a verifiable presentation.
     *
     * @param presentationId the presentation identifier
     * @return the next stage of completion, including the verifiable presentation
     */
    public CompletionStage&lt;VerifiablePresentation&gt; getPresentation(final String presentationId) {
<span class="nc" id="L213">        final var req = Request</span>
<span class="nc" id="L214">            .newBuilder(getPresentationEndpoint(Objects.requireNonNull(presentationId)))</span>
<span class="nc" id="L215">                .build();</span>
<span class="nc" id="L216">        return httpClient.send(req, VerifiableCredentialBodyHandlers.ofVerifiablePresentation())</span>
<span class="nc" id="L217">                .thenApply(Response::body);</span>
    }

    /**
     * Delete a presentation.
     *
     * @param presentationId the presentation identifier
     * @return the next stage of completion
     */
    public CompletionStage&lt;Void&gt; deletePresentation(final String presentationId) {
<span class="nc" id="L227">        final var req = Request.newBuilder(getPresentationEndpoint(Objects.requireNonNull(presentationId)))</span>
<span class="nc" id="L228">            .DELETE().build();</span>

<span class="nc" id="L230">        return httpClient.send(req, Response.BodyHandlers.discarding())</span>
<span class="nc" id="L231">            .thenApply(res -&gt; {</span>
<span class="nc" id="L232">                final int httpStatus = res.statusCode();</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">                if (httpStatus &gt;= 200 &amp;&amp; httpStatus &lt; 300) {</span>
<span class="nc" id="L234">                    return res.body();</span>
                }
<span class="nc" id="L236">                throw new VerifiableCredentialException(</span>
                    &quot;Unexpected error while deleting presentation &quot;,
                    httpStatus);
            });
    }

    /**
     * Prove a presentation.
     *
     * @param request the prove request
     * @return the next stage of completion, including the verifiable presentation
     */
    public CompletionStage&lt;VerifiablePresentation&gt; prove(final ProveRequest request) {
<span class="nc" id="L249">        final var req = Request.newBuilder(getProveEndpoint())</span>
<span class="nc" id="L250">            .header(CONTENT_TYPE, APPLICATION_JSON)</span>
<span class="nc" id="L251">            .POST(serialize(request))</span>
<span class="nc" id="L252">            .build();</span>

<span class="nc" id="L254">        return httpClient.send(req, VerifiableCredentialBodyHandlers.ofVerifiablePresentation())</span>
<span class="nc" id="L255">            .thenApply(Response::body);</span>
    }

    /**
     * Initiate a presentation exchange.
     *
     * @param exchangeId a unique identifier for a shared exchange
     * @param request the exchange request
     * @return the server-generated VP Request
     */
    // Request payload example:
    // {
    //   &quot;query&quot;: {
    //     &quot;type&quot;: &quot;QueryByExample&quot;,
    //     &quot;credentialQuery&quot;: {
    //       &quot;type&quot;: [&quot;VerifiableCredential&quot;, &quot;SolidAccessGrant&quot;],
    //       &quot;reason&quot;: &quot;Access to a Solid Resource&quot;
    //     }
    //   }
    // }
    //
    // Response payload example:
    // {
    //   &quot;query&quot;: [
    //     {
    //       &quot;type&quot;: [&quot;QueryByExample&quot;],
    //       &quot;credentialQuery&quot;: {
    //         &quot;frame&quot;: {
    //           &quot;@context&quot;: [...],
    //           &quot;type&quot;: [&quot;VerifiableCredential&quot;, &quot;SolidAccessGrant&quot;],
    //           &quot;credentialSubject&quot;: { ... }
    //         }
    //       }
    //     }
    //   ],
    //   &quot;domain&quot;: &quot;credentials.example&quot;,
    //   &quot;challenge&quot;: &quot;3182bdea-63d9-11ea-b6de-3b7c1404d57f&quot;
    // }
    /**
     * Initiate a presentation exchange.
     *
     * @param exchangeId a unique identifier for a shared exchange
     * @param request the exchange request
     * @return the next stage of completion, including a server-generated VP Request
     */
    public CompletionStage&lt;VerifiablePresentationRequest&gt; initiateExchange(final String exchangeId,
            final ExchangeRequest request) {
<span class="nc" id="L302">        final var req = Request.newBuilder(getExchangeEndpoint(Objects.requireNonNull(exchangeId)))</span>
<span class="nc" id="L303">            .header(CONTENT_TYPE, APPLICATION_JSON)</span>
<span class="nc" id="L304">            .POST(serialize(request))</span>
<span class="nc" id="L305">            .build();</span>

<span class="nc" id="L307">        return httpClient.send(req, ofVerifiablePresentationRequest())</span>
<span class="nc" id="L308">            .thenApply(Response::body);</span>
    }

    /**
     * Continue an existing exchange.
     *
     * @param exchangeId the exchange identifier
     * @param transactionId the transaction identifier
     * @param presentation the verifiable presentation
     * @return the next stage of completion
     */
    public CompletionStage&lt;Void&gt; continueExchange(final String exchangeId, final String transactionId,
            final VerifiablePresentation presentation) {
        // TODO - implement
<span class="nc" id="L322">        return null;</span>
    }

    /**
     * A data structure for exchange requests when interacting with a VC Holder API.
     */
<span class="nc" id="L328">    public static class ExchangeRequest {</span>
        /**
         * The exchange query.
         */
        public Query query;
    }

    /**
     * A data structure for query specifications when interacting with a VC Holder API.
     */
<span class="nc" id="L338">    public static class Query {</span>
        /**
         * The query type.
         */
        public URI type;

        /**
         * The credential query.
         */
        public Map&lt;String, Object&gt; credentialQuery;
    }

    /**
     * A data structure for derive requests when interacting with a VC Holder API.
     */
<span class="nc" id="L353">    public static class DerivationRequest {</span>
        /**
         * The credential to derive.
         */
        public VerifiableCredential verifiableCredential;

        /**
         * A frame for the derived credential.
         */
        public Map&lt;String, Object&gt; frame;

        /**
         * Options for the derive request.
         */
        public Map&lt;String, Object&gt; options;
    }

    /**
     * A data structure for prove requests when interacting with a VC Holder API.
     */
<span class="nc" id="L373">    public static class ProveRequest {</span>
        /**
         * The presentation to prove.
         */
        public VerifiablePresentation presentation;

        /**
         * Options for the prove request.
         */
        public Map&lt;String, Object&gt; options;
    }

    private Response.BodyHandler&lt;VerifiablePresentationRequest&gt; ofVerifiablePresentationRequest() {
<span class="nc" id="L386">        return responseInfo -&gt; {</span>
<span class="nc" id="L387">            final int httpStatus = responseInfo.statusCode();</span>
<span class="nc bnc" id="L388" title="All 4 branches missed.">            if (httpStatus &gt;= 200 &amp;&amp; httpStatus &lt; 300) {</span>
<span class="nc" id="L389">                try (final InputStream input = new ByteArrayInputStream(responseInfo.body().array())) {</span>
<span class="nc" id="L390">                    return jsonService.fromJson(input, VerifiablePresentationRequest.class);</span>
<span class="nc" id="L391">                } catch (final IOException ex) {</span>
<span class="nc" id="L392">                    throw new VerifiableCredentialException(&quot;Error parsing presentation request&quot;, ex);</span>
                }
            }
<span class="nc" id="L395">            throw new VerifiableCredentialException(</span>
                    &quot;Unexpected error response when handling a verifiable presentation.&quot;,
                    httpStatus);
        };
    }

    private &lt;T&gt; Request.BodyPublisher serialize(final T request) {
<span class="nc" id="L402">        return IOUtils.buffer(out -&gt; {</span>
            try {
<span class="nc" id="L404">                jsonService.toJson(request, out);</span>
<span class="nc" id="L405">            } catch (final IOException ex) {</span>
<span class="nc" id="L406">                throw new VerifiableCredentialException(&quot;Error serializing JSON&quot;, ex);</span>
<span class="nc" id="L407">            }</span>
<span class="nc" id="L408">        });</span>
    }

    private URI getPresentationListEndpoint(final List&lt;URI&gt; types) {
<span class="nc" id="L412">        return URIBuilder.newBuilder(baseUri).path(PRESENTATIONS)</span>
<span class="nc" id="L413">            .queryParam(&quot;type&quot;, types.stream().map(URI::toString).collect(Collectors.joining(&quot;,&quot;)))</span>
<span class="nc" id="L414">            .build();</span>
    }

    private URI getCredentialListEndpoint(final List&lt;URI&gt; types) {
<span class="nc" id="L418">        return URIBuilder.newBuilder(baseUri).path(CREDENTIALS)</span>
<span class="nc" id="L419">            .queryParam(&quot;type&quot;, types.stream().map(URI::toString).collect(Collectors.joining(&quot;,&quot;)))</span>
<span class="nc" id="L420">            .build();</span>
    }

    private URI getPresentationEndpoint(final String presentationId) {
<span class="nc" id="L424">        return URIBuilder.newBuilder(baseUri).path(PRESENTATIONS).path(presentationId).build();</span>
    }

    private URI getCredentialEndpoint(final String credentialId) {
<span class="nc" id="L428">        return URIBuilder.newBuilder(baseUri).path(CREDENTIALS).path(credentialId).build();</span>
    }

    private URI getDeriveEndpoint() {
<span class="nc" id="L432">        return URIBuilder.newBuilder(baseUri).path(CREDENTIALS).path(&quot;derive&quot;).build();</span>
    }

    private URI getProveEndpoint() {
<span class="nc" id="L436">        return URIBuilder.newBuilder(baseUri).path(PRESENTATIONS).path(&quot;prove&quot;).build();</span>
    }

    private URI getExchangeEndpoint(final String exchangeId) {
<span class="nc" id="L440">        return URIBuilder.newBuilder(baseUri).path(EXCHANGES).path(exchangeId).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>